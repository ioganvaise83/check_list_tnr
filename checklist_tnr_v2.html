<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Чек-лист речевого развития (ТНР)</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
    }
    body {
      margin: 0;
      background: #f5f6fa;
      color: #111;
      font-size: 16px;
    }
    .container {
      max-width: 480px;
      margin: 0 auto;
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }
    h1 {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      line-height: 1.3;
      text-align: center;
    }
    p.lead {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 1rem;
      text-align: center;
    }
    .meta label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      font-size: 1rem;
      border: 1px solid #d0d4dd;
      border-radius: 6px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 50px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead { display: none; }
    tr {
      display: block;
      background: #fff;
      border: 1px solid #e6e9ef;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }
    td {
      display: block;
      padding: 8px;
    }
    td:first-child {
      font-weight: 600;
      font-size: 0.95rem;
      padding-bottom: 4px;
    }
    td:nth-child(2)::before { content: "Оценка: "; font-weight: 600; }
    td:nth-child(3)::before { content: "Комментарий: "; font-weight: 600; display: block; margin-top: 4px; }
    .actions {
      position: sticky;
      bottom: 0;
      background: #fff;
      padding: 10px;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.08);
      border-radius: 10px 10px 0 0;
    }
    button.save {
      width: 100%;
      background: #2563eb;
      color: #fff;
      border: none;
      padding: 14px;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
    }
    button.save[disabled] { opacity: 0.6; cursor: not-allowed; }
    #result { margin-top: 8px; font-size: 0.9rem; }
    .msg.ok { background: #e6fff0; border-radius: 6px; padding: 6px; color: #084b2c; }
    .msg.err { background: #fff1f2; border-radius: 6px; padding: 6px; color: #6b1220; }
    footer {
      font-size: 0.8rem;
      color: #666;
      text-align: center;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Чек-лист речевого развития (ТНР)</h1>
    <p class="lead">Средний дошкольный возраст. Отметьте «Да», «Частично» или «Нет». После заполнения нажмите «Сохранить».</p>

    <div class="meta">
      <label>ФИО ребёнка<input id="childName" type="text" placeholder="Иванов Иван" /></label>
      <label>Дата обследования<input id="date" type="date" /></label>
      <label>Специалист<input id="specialist" type="text" placeholder="ФИО специалиста" /></label>
    </div>

    <table id="checklist"><tbody></tbody></table>

    <div class="actions">
      <button class="save" id="saveBtn">Сохранить</button>
      <div id="result"></div>
    </div>

    <footer>На основе п. 32.3.3 Стандарта (Приказ ДОгМ №666) • <span id="now"></span></footer>
  </div>

  <script>
    const ITEMS = [
      {key:'need_communication', text:'Проявляет интерес к речевому взаимодействию (инициирует общение)'},
      {key:'responds_name', text:'Откликается на обращение по имени, поддерживает зрительный контакт'},
      {key:'simple_sentences', text:'Строит простые предложения (2–4 слова)'},
      {key:'participates_dialogue', text:'Участвует в диалоге из 2–3 реплик'},
      {key:'uses_nonverbal', text:'Использует невербальные средства коммуникации (жест, мимика)'},
      {key:'plays_with_peers', text:'Играет совместно с другими детьми'},
      {key:'emotional_contact', text:'Поддерживает эмоциональный контакт с педагогом'}
    ];

    const tbody = document.querySelector('#checklist tbody');
    ITEMS.forEach(it => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.text}</td>
        <td><select name="${it.key}"><option value="">---</option><option>Да</option><option>Частично</option><option>Нет</option></select></td>
        <td><textarea name="${it.key}_comment" placeholder="Комментарий"></textarea></td>`;
      tbody.appendChild(tr);
    });

    document.getElementById('now').textContent = new Date().toLocaleString();
    document.getElementById('date').valueAsDate = new Date();

    function collectData() {
      const data = {
        childName: document.getElementById('childName').value || null,
        date: document.getElementById('date').value || null,
        specialist: document.getElementById('specialist').value || null,
        createdAt: new Date().toISOString(),
        answers: []
      };
      ITEMS.forEach(it => {
        const val = document.querySelector(`[name="${it.key}"]`).value;
        const comm = document.querySelector(`[name="${it.key}_comment"]`).value;
        data.answers.push({key: it.key, label: it.text, value: val || null, comment: comm || null});
      });
      return data;
    }

    function validate(data){
      if(!data.answers.some(a=>a.value)) return {ok:false,msg:'Выберите хотя бы один ответ.'};
      return {ok:true};
    }

    document.getElementById('saveBtn').addEventListener('click', async ()=>{
      const result = document.getElementById('result');
      result.innerHTML = '';
      const btn = document.getElementById('saveBtn');
      btn.disabled = true;
      try {
        const data = collectData();
        const v = validate(data);
        if(!v.ok){ result.innerHTML = `<div class='msg err'>${v.msg}</div>`; btn.disabled=false; return; }
        const res = await fetch('/api/checklist', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
        if(res.ok) result.innerHTML = `<div class='msg ok'>✅ Отправлено успешно</div>`;
        else result.innerHTML = `<div class='msg err'>Ошибка: ${res.status}</div>`;
      } catch(e){
        result.innerHTML = `<div class='msg err'>Ошибка сети: ${e.message}</div>`;
      } finally { btn.disabled = false; }
    });
  </script>
</body>
</html>